---
layout: post
title: "CouchDB"
date: 2021-05-06 
description: "CouchDB"
tag: fabric 


---

------

# CouchDB

​		Apache CouchDB 是一个面向文档的数据库管理系统。它提供以 JSON 作为数据格式的 REST 接口来对其进行操作，并可以通过视图来操纵文档的组织和呈现。 CouchDB 是 Apache 基金会的顶级开源项目。

## 介绍

​		couchDB的字段只有三个：文档ID、文档版本号和内容。内容字段可以看到是一个text类型的文本，里面可以随意定义数据，而不用关注数据类型，但数据必须以json的形式表示并存放。例如一个表述用户的文档可以表示为：[_id:1001, _rev:1-32443289, {'name':'wentrue', 'location':'beijing'}]。couchDB把所有的属性忽略schema都统一放在一个字段里，那么当有两个程序同时修改这个字段时，就有可能造成先写入的数据被后写入的数据覆盖的现象，导致数据不一致。couchDB利用版本号来解决这个问题，当有程序需要修改一条数据时，它必须先把这个数据的版本号读出来，写入的时候，连版本号一并写入，此时couchDB会检查该版本号是否与原数据的一致，如果一致则写入，如果不一致，则说明数据在该程序读出后已经被修改过，couchDB会写入不成功，返回一个冲突的信号，待客户端程序处理。

​		couchDB的底层是erlang语言，以RESTful API的格式提供服务，couchDB所有的读写能力都可以通过简单的调用它的HTTP请求来实现。正因为采用那么一种统一且简洁的服务接口，可以很方便地开发各种语言的客户端，以方便不同程序员的使用。

​		couchDB的主要特点在于易用性及并发性。couchDB的底层是一个B-tree的存储结构，为提高效率，所有的数据的插入或更新都是直接在树的叶子节点添加，不删除旧节点，通过版本号来确定最新的数据－－版本号还能用来解决并发写的冲突。所以数据文件会越来越大，可以在适当地时间运行compact过程或replication过程，会删除旧文件，使得数据文件得到压缩。

​		couchDB的属性可以灵活增删，要增加一个新属性只需要往数据字段多写入一个属性即可。couchDB以json格式存储数据，返回的数据也默认为json格式，这对于前端的javascript处理是非常方便的。

## 区块链中的使用

​		在Fabric链码中，不管是通过 `GetState()` 、`GetPrivateData` 或`GetStateByPartialCompositeKey` 等来从账本中获取数据时，它们都是通过账本数据的 `Key` 来确定数据。在某些场景下，可能会需要通过账本数据中的 `Value` 值来筛选数据（如获取性别为男的所有数据）。当然，使用组合键也能达到这种需求，但组合键的创建和存储都比较麻烦（需要所有的组合键都需要被创建和存储到账本数据中，本质上组合键也是通过Key来筛选数据）。

### 富查询

​		为了能够简单的通过Value值来筛选数据，在链码中可以使用CouchDB的富查询功能。 `shim.ChaincodeStubInterface` 实例所提供的的 `GetQueryResult` 方法可实现富查询功能。该方法需传入一个Json对象，key 为 `selector` ，value为待筛选的属性值。如 `{"selector":{"sex":"男"},{"province":"浙江"}}`

``` go
func GetCommodityByName(stub shim.ChaincodeStubInterface, args []string) pb.Response {
	//todo
	if len(args) != 1 {
		return shim.Error("参数非法！参数顺序：name")
	}
    // `{"selector":{"属性名":"属性值"}}`
	query := fmt.Sprintf(`{"selector":{"name":"%v"}}`,args[0])
	var commodities []Commodity
	iterator,_ := stub.GetQueryResult(query)
	defer iterator.Close()
	for iterator.HasNext() {
		kv,_ := iterator.Next()
		var commodity Commodity
		_ = json.Unmarshal(kv.Value,&commodity)
		fmt.Println(commodity)
		commodities = append(commodities,commodity)
	}
	data,_ := json.Marshal(commodities)
	return shim.Success(data)
}
```

### 索引

​		智能合约代码中业务如果涉及到couchdb的富查询，例如根据供应商去查询一些相关的信息，如果没有建立索引的话，在查询中会慢的很痛苦，而且数据量大的情况下会出现莫名的error。

​		couchDB的索引创建很简单，只需在链码的同级目录下建立文件夹META-INF/statedb/couchdb/indexes/，并添加一个json文件：

``` json
{
  "index": {
    "fields": [
      "属性名"
    ]
  },
  "ddoc": "自定义名称",
  "name": "自定义名称",
  "type": "json"
}
```

Fabric-samples项目中的链码包 `marbles02` 所使用的索引文件为：

`{"index":{"fields":["docType","owner"]},"ddoc":"indexOwnerDoc", "name":"indexOwner","type":"json"}`